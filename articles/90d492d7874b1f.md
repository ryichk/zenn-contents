---
title: "Go Echoã‚µãƒ¼ãƒãƒ¼ã‚’Lambda Web Adapter + SAM + Lambda Function URLsã§å…¬é–‹ã™ã‚‹"
emoji: "ğŸ¶"
type: "tech"
topics: ["Go", "Lambda", "sam", "echo", "lambdawebadapter"]
published: true
published_at: 2024-08-24
---

# èƒŒæ™¯

Goã§ä½œã£ãŸWebã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’Lambdaã§å‹•ã‹ã™æ–¹æ³•ã‚’èª¿ã¹ã¦ã„ãŸéš›ã«[AWS Lambda Web Adapter](https://github.com/awslabs/aws-lambda-web-adapter)ã¨ã„ã†æŠ€è¡“ã®å­˜åœ¨ã‚’çŸ¥ã‚Šã¾ã—ãŸã€‚

https://aws.amazon.com/jp/builders-flash/202301/lambda-web-adapter/

AWS Lambda Web Adapterã‚’ä½¿ãˆã°æ§˜ã€…ãªWebã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§æ§‹ç¯‰ã•ã‚ŒãŸwebã‚¢ãƒ—ãƒªã‚’Lambdaã§å‹•ã‹ã™ã“ã¨ãŒã§ãã¾ã™ã€‚(Express.jsã€Flaskã€Laravelã€Next.jsã€...etc.)

https://github.com/awslabs/aws-lambda-web-adapter?tab=readme-ov-file#examples

å…¬å¼ã®Examplesã«è¼‰ã£ã¦ã„ãªã„Ruby on Railsãªã©ã®Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚‚Lambdaã§å‹•ã‹ã›ã‚‹ã¨æ¨æ¸¬ã§ãã¾ã™ã€‚

RuntimeåŸ‹ã‚è¾¼ã¿ç³»ã®Adapterã¨ã„ã†ã®ã‚‚ã„ãã¤ã‹å­˜åœ¨ã™ã‚‹ã‚ˆã†ã§ã™ãŒã€ãã‚Œã‚’ä½¿ã†ãƒ‡ãƒ¡ãƒªãƒƒãƒˆã¨Lambda Web Adapterã‚’ä½¿ã†å ´åˆã®ãƒ¡ãƒªãƒƒãƒˆã¯ã“ã¡ã‚‰ã®ã‚¹ãƒ©ã‚¤ãƒ‰ãŒã¨ã¦ã‚‚å‚è€ƒã«ãªã‚Šã¾ã—ãŸã€‚
https://speakerdeck.com/_kensh/web-frameworks-on-lambda?slide=29
https://speakerdeck.com/_kensh/web-frameworks-on-lambda?slide=67

ä»Šå›ã¯ã€Goã®Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã‚ã‚‹[Echo](https://github.com/labstack/echo)ã§ä½œã£ãŸç°¡æ˜“çš„ãªã‚µãƒ¼ãƒãƒ¼ã‚¢ãƒ—ãƒªã‚’AWS Lambda Web Adapterã¨SAM([serverless-application-model](https://github.com/aws/serverless-application-model))ã‚’ä½¿ã£ã¦Lambda Function URLs (é–¢æ•°URL)ã§å…¬é–‹ã—ã¦ã¿ã¾ã—ãŸã€‚

ç§ãŒä½œæˆã—ãŸã‚³ãƒ¼ãƒ‰ã¯GitHubã§ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã¨ã—ã¦å…¬é–‹ã—ã¦ã„ã¾ã™ã€‚

https://github.com/ryichk/go-echo-lambda-function-url-template

è‡ªåˆ†ãŒèª¿æŸ»ã—ãŸéš›ã¯AWS Lambda Web Adapterã®å…¬å¼Examplesã§[Gin](https://github.com/gin-gonic/gin)ã‚’ä½¿ã£ãŸã‚µãƒ³ãƒ—ãƒ«ã‚„Zennã®è¨˜äº‹ã§[Fiber](https://github.com/gofiber/fiber)ã‚’ä½¿ã£ãŸã‚µãƒ³ãƒ—ãƒ«ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ã¯ã§ãã¾ã—ãŸãŒã€Echoã‚’ä½¿ã£ãŸã‚µãƒ³ãƒ—ãƒ«ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ããªã‹ã£ãŸã®ã§ã“ã†ã—ã¦è¨˜äº‹ã¨ã—ã¦å…¬é–‹ã™ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚

https://github.com/awslabs/aws-lambda-web-adapter/tree/main/examples/gin

https://zenn.dev/the_exile/articles/75269a81f49f62

# æ‰‹é †ãƒ»è§£èª¬

## 1. Echoã‚µãƒ¼ãƒãƒ¼ã®æ§‹ç¯‰

Echoã§Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚
ä»Šå›ã¯ç°¡å˜ã«[localhost:8000/](http://localhost:8000)ã¸ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã‚‰`Hello!`ã¨è¡¨ç¤ºã•ã‚Œã‚‹ã ã‘ã®ã‚¢ãƒ—ãƒªã‚’æ§‹ç¯‰ã—ã¾ã—ãŸã€‚

```go
package main

import (
	"net/http"

	"github.com/labstack/echo/v4"
	"github.com/labstack/echo/v4/middleware"
)

func main() {
	e := echo.New()
	e.GET("/", hello)
	e.Logger.Fatal(e.Start(":8000"))
}

func hello(c echo.Context) error {
	return c.String(http.StatusOK, "Hello!")
}
```

## 2. Dockerfileã‚’ä½œæˆ

Dockerfileã¯[Lambda Web Adapterã®å…¬å¼Examplesã§å…¬é–‹ã•ã‚Œã¦ã„ã‚‹ginã®Dockerfile](https://github.com/awslabs/aws-lambda-web-adapter/blob/main/examples/gin/app/Dockerfile)ã‚’å‚è€ƒã«ã—ã¾ã—ãŸã€‚

```dockerfile
FROM golang:1.23-alpine AS build_base
RUN apk add --no-cache git
WORKDIR /app

COPY . .
RUN go mod download

RUN GOOS=linux CGO_ENABLED=0 go build -o bootstrap ./app
FROM alpine:3.9
RUN apk add ca-certificates

# Lambda Web Adapterã‚’Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã§ä½¿ç”¨ã™ã‚‹ãŸã‚ã«å¿…è¦ãªã®ã¯ã“ã®1è¡Œã‚’è¿½åŠ ã™ã‚‹ã ã‘ã§ã™
COPY --from=public.ecr.aws/awsguru/aws-lambda-adapter:0.8.4 /lambda-adapter /opt/extensions/lambda-adapter
COPY --from=build_base /app/bootstrap /app/bootstrap

ENV PORT=8000 AWS_LWA_ASYNC_INIT=true
EXPOSE 8000

CMD ["/app/bootstrap"]
```

Lambda Web Adapterã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§8080ç•ªãƒãƒ¼ãƒˆã‚’Webã‚¢ãƒ—ãƒªãŒãƒªãƒƒã‚¹ãƒ³ã—ã¦ã„ã‚‹ã¨æƒ³å®šã—ã¦ã„ã¾ã™ã€‚
ãã®ãŸã‚ã€8080ç•ªãƒãƒ¼ãƒˆä»¥å¤–ã‚’ä½¿ç”¨ã—ãŸã„å ´åˆã¯ç’°å¢ƒå¤‰æ•°`PORT`ã‹`AWS_LWA_PORT`ã§ä»»æ„ã®ãƒãƒ¼ãƒˆç•ªå·ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ã—ã‹ã—ã€Lambdaå®Ÿè¡Œç’°å¢ƒã§Webã‚¢ãƒ—ãƒªã¯érootãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦å®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚1024ä»¥ä¸‹ã®ãƒãƒ¼ãƒˆç•ªå·ã‚’ãƒªãƒƒã‚¹ãƒ³ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚
ã¾ãŸã€3000ç•ªã¨9001ç•ªã‚‚ãƒãƒ¼ãƒˆã¨ã—ã¦åˆ©ç”¨ã™ã‚‹ã“ã¨ã¯é¿ã‘ãŸæ–¹ãŒè‰¯ã•ãã†ã§ã™ã€‚
3000ç•ªã¯ã€CloudWatch Lambda Insight extensionãŒä½¿ç”¨ã—ã€9001ç•ªã¯Lambda Runtime APIãŒä½¿ç”¨ã™ã‚‹ãŸã‚ã§ã™ã€‚

å‚è€ƒï¼šhttps://github.com/awslabs/aws-lambda-web-adapter?tab=readme-ov-file#configurations:~:text=AWS_LWA_PORT%20/%20PORT%20%2D%20Lambda,uses%20port%203000.

ä»¥ä¸‹ã®ç’°å¢ƒå¤‰æ•°ã¯ãªãã¦ã‚‚å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚

```env
AWS_LWA_ASYNC_INIT=true
```

Lambdaé–¢æ•°ãŒ10ç§’ä»¥å†…ã«åˆæœŸåŒ–ã‚’å®Œäº†ã§ããªã‹ã£ãŸå ´åˆã€Lambdaã¯é–¢æ•°ã‚’å†èµ·å‹•ã—ã€åˆæœŸåŒ–ã®æ–™é‡‘ã‚’è«‹æ±‚ã—ã¾ã™ã€‚
Lambda Web Adapterã¯ã€ã“ã®10ç§’é–“ã®åˆæœŸåŒ–æ™‚é–“ã‚’æœ‰åŠ¹ã«ä½¿ã£ã¦åˆæœŸåŒ–ã®å†èµ·å‹•ã‚’å›é¿ã™ã‚‹ãŸã‚ã«éåŒæœŸåˆæœŸåŒ–ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚
ã“ã®æ©Ÿèƒ½ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã¨ã€æœ€å¤§9.8ç§’ã®æº–å‚™å®Œäº†ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã„ã€ãã‚Œã¾ã§ã«Webã‚¢ãƒ—ãƒªã®æº–å‚™ãŒå®Œäº†ã—ãªã‹ã£ãŸã‚‰Lambdaã‚µãƒ¼ãƒ“ã‚¹ã«åˆæœŸåŒ–ãŒå®Œäº†ã—ãŸã“ã¨ã‚’é€šçŸ¥ã—ã€ãƒãƒ³ãƒ‰ãƒ©å†…ã§æº–å‚™å®Œäº†ãƒã‚§ãƒƒã‚¯ã‚’ç¶™ç¶šã—ã¾ã™ã€‚
ã“ã®æ©Ÿèƒ½ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ç„¡åŠ¹ã«ãªã£ã¦ã„ã¾ã™ãŒã€ç’°å¢ƒå¤‰æ•°`AWS_LWA_ASYNC_INIT`ã¾ãŸã¯`ASYNC_INIT`ã‚’trueã«è¨­å®šã™ã‚‹ã“ã¨ã§æœ‰åŠ¹ã«ã§ãã¾ã™ã€‚

å‚è€ƒï¼šhttps://github.com/awslabs/aws-lambda-web-adapter?tab=readme-ov-file#configurations:~:text=AWS_LWA_ASYNC_INIT%20/%20ASYNC_INIT%20%2D%20Lambda,to%20true.

## 3. SAMã®template.yamlã‚’ä½œæˆ

Lambda Function URLsã‚’ä½¿ã†ã«ã‚ãŸã£ã¦ã€[Lambda Web Adapterã®å…¬å¼Examplesã§å…¬é–‹ã•ã‚Œã¦ã„ã‚‹nextjs-response-streamingã®template.yaml](https://github.com/awslabs/aws-lambda-web-adapter/blob/main/examples/nextjs-response-streaming/template.yaml)ã‚’å‚è€ƒã«ã—ã¾ã—ãŸã€‚

```yaml
AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: SAM Template for Go's Echo Web application.

Globals:
  Function:
    Timeout: 5
    MemorySize: 128

Resources:
  GoEchoAppFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: app/
      PackageType: Image
      Architectures:
      - x86_64
      FunctionUrlConfig:
        AuthType: NONE
    Metadata:
      DockerTag: v1
      DockerContext: .
      Dockerfile: Dockerfile

Outputs:
  GoEchoAppFunctionOutput:
    Description: "Go's Echo App Function ARN"
    Value: !GetAtt GoEchoAppFunction.Arn
  GoEchoAppFunctionUrlOutput:
    Description: "Go's Echo App Function URL"
    Value: !GetAtt GoEchoAppFunctionUrl.FunctionUrl
```

FunctionUrlConfigã®AuthTypeã‚’NONEã«è¨­å®šã—ã¦ã„ã‚‹ãŸã‚ã€èª°ã§ã‚‚ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªURLã¨ã—ã¦å…¬é–‹ã•ã‚Œã¾ã™ã€‚

## 5. SAM CLIã§ãƒ“ãƒ«ãƒ‰

```shell
$ sam build
Building codeuri: /Pathto/go-echo-lambda-function-url-template runtime: None architecture: x86_64 functions: GoEchoAppFunction
Building image for GoEchoAppFunction function
Setting DockerBuildArgs for GoEchoAppFunction function
Step 1/13 : FROM golang:1.23-alpine AS build_base

~ çœç•¥ ~

Successfully tagged goechoappfunction:v1


Build Succeeded

Built Artifacts  : .aws-sam/build
Built Template   : .aws-sam/build/template.yaml

```

## 6. SAM CLIã§ãƒ‡ãƒ—ãƒ­ã‚¤

```shell
$ sam deploy

~ çœç•¥ ~

Previewing CloudFormation changeset before deployment
======================================================
Deploy this changeset? [y/N]: y

2024-08-24 21:45:24 - Waiting for stack create/update to complete

CloudFormation events from stack operations (refresh every 5.0 seconds)
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
ResourceStatus                                                 ResourceType                                                   LogicalResourceId                                              ResourceStatusReason
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
UPDATE_IN_PROGRESS                                             AWS::CloudFormation::Stack                                     go-echo-app                                                    User Initiated
UPDATE_IN_PROGRESS                                             AWS::Lambda::Function                                          GoEchoAppFunction                                              -
UPDATE_COMPLETE                                                AWS::Lambda::Function                                          GoEchoAppFunction                                              -
UPDATE_COMPLETE_CLEANUP_IN_PROGRESS                            AWS::CloudFormation::Stack                                     go-echo-app                                                    -
UPDATE_COMPLETE                                                AWS::CloudFormation::Stack                                     go-echo-app                                                    -
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

CloudFormation outputs from deployed stack
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Outputs
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Key                 GoEchoAppFunctionUrlOutput
Description         Go's Echo App Function URL
Value               https://xxx.lambda-url.ap-northeast-1.on.aws/

Key                 GoEchoAppFunctionOutput
Description         Go's Echo App Function ARN
Value               arn:aws:lambda:ap-northeast-1:000000000000:function:go-echo-app-GoEchoAppFunction-XXXXXXXX
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


Successfully created/updated stack - go-echo-app in ap-northeast-1
```

## 7. å‹•ä½œç¢ºèª

```shell
$ curl https://xxx.lambda-url.ap-northeast-1.on.aws/
Hello!%
```

## 8. ãƒªã‚½ãƒ¼ã‚¹ã®å‰Šé™¤

```shell
$ sam delete
```

## ãã®ä»–å‚è€ƒã«ã—ãŸè³‡æ–™

https://aws.amazon.com/jp/builders-flash/202402/lambda-container-runtime/
https://echo.labstack.com/docs/quick-start
